@page "/v008entities/search"
@using Data.Model
@using Front.Services
@using System.ComponentModel.DataAnnotations
@inject V008EntityService V008EntityService
@rendermode InteractiveServer

<h3>Поиск</h3>

<EditForm Model="searchModel" OnValidSubmit="HandleValidSubmit" FormName="V008EntityFind">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label for="searchId">ID</label>
        <InputNumber id="searchId" class="form-control" @bind-Value="searchModel.Id" />
    </div>

    <button type="submit" class="btn btn-primary">Поиск</button>
</EditForm>

@if (isSearching)
{
    <p><em>Выполняется поиск...</em></p>
}
else if (entity != null)
{
    <h4>Результаты поиска:</h4>
    <div>
        <p><strong>ID:</strong> @entity.Id</p>
        <p><strong>Код:</strong> @entity.Code</p>
        <p><strong>Название:</strong> @entity.Name</p>
        <p><strong>Дата начала:</strong> @entity.BeginDate</p>
        <p><strong>Дата окончания:</strong> @entity.EndDate</p>
    </div>
}
else if (hasSearched)
{
    <p>Запись не найдена.</p>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@code {
    private SearchModel searchModel = new SearchModel();
    private V008Entity entity;
    private bool isSearching = false;
    private bool hasSearched = false;
    private string errorMessage;

    private async Task HandleValidSubmit()
    {
        isSearching = true;
        hasSearched = false;
        entity = null;
        errorMessage = null;

        try
        {
            Console.WriteLine($"Id: {searchModel}");
            if (searchModel.Id != null)
            {
                entity = await V008EntityService.GetByIdAsync(searchModel.Id.Value);
            }
            else
            {
                errorMessage = "Введите ID для поиска.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Произошла ошибка: {ex.Message}";
        }
        finally
        {
            isSearching = false;
            hasSearched = true;
        }
    }
    public class SearchModel
    {
        public int? Id { get; set; }
        public static ValidationResult ValidateSearch(SearchModel model, ValidationContext context)
        {
            if (model.Id == null)
            {
                return new ValidationResult("Необходимо ввести ID или код для поиска.");
            }
            return ValidationResult.Success;
        }
    }
}
